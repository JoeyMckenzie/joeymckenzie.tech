{
  "title": "Clean architecture, Dapper, MediatR, and buzzword bingo (part 2)",
  "description": "Implement the unit of work and repository patterns with Dapper.",
  "pubDate": "2019-10-06T07:00:00.000Z",
  "category": ".NET",
  "heroImage": "https://imgs.xkcd.com/comics/code_quality.png",
  "draft": false,
  "keywords": [
    ".net",
    "c#",
    "dapper",
    "mediatr"
  ],
  "body": {
    "raw": "\n_UPDATE: I've added cancellation token support to each of the database operations below, and encourage readers to\ncheckout the `master` branch to see how things look now. The methods below we're slight altered to use\na `CommandDefinition` that utilizes a `CancellationToken` passed down from the core business logic layer, and used in\nplace of the regular string queries we've written below._\n\nWe finally made it... our domain layer is ready to roll, and it's now time to spin up some actual application code. In\nour [last post](/images/net-core-dapper-and-crud-buzzword-bingo/), we setup our initial domain layer for our favorite\nfictional brewery, Dappery ([source code](https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-1-domain-layer) for\nreference). In this post, we'll build out the data access layer that will be our primary persistence mechanism into our\ndatabase. We'll make use of SQL server (or Postgres) with Docker and SQLite running our unit tests within this layer.\nFeel free to checkout the [source code](https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-2-data-layer) on\nGitHub for this section for those following along.\n\nBefore we jump into the code, let's take a step back and understand _why_ we separate our our data access layer (DAL)\nfrom the rest of our code.\n\n![Inward_Facing_Dependencies](/images/net-core-dapper-and-crud-series/part-2/inward_dependencies.png)\n\nThe good ole fashioned dependency graph, made famous by Robert Martin a.k.a. Dr. Bob, lays out the foundation of domain\ndriven design (DDD). For our relatively simple application, we focus on creating four distinct layers within our\napplication code to ensure that the layers are ultimately, by some chain of dependency, dependent on the domain layer (\neffectively the 'D' in SOLID, [dependency inversion](https://en.wikipedia.org/wiki/Dependency_inversion_principle)).\nWith our layers pointing inward toward our domain, we create _clear_ boundaries within our application that deal with\nseparate concerns:\n\n-   The web and persistence layers directly depend on our core layer\n-   Our core layer directly depends on the domain layer\n-   By association, our web and persistence, inadvertently, have a dependency on our domain layer\n-   The domain layer has **no** dependencies - all it knows, and cares about, are the entities, view models, DTOs, etc.\n    that live inside this project and how each is related\n\nCreating these clear boundaries of separation helps to create a modular application, with each layer isolated from one\nanother in perfect harmony. By creating this inversion of dependency within our application, for example, our core layer\n_does not_ need to know about ANY of the internal workings of the data layer - all the core layer cares about is that it\ncan get data from a database using this [actor](https://en.wikipedia.org/wiki/Actor_model). How the persistence layer\ninteracts with the database is entirely abstracted from our core layer. Our data layer can change its data interaction\nmechanism, swap database providers, etc. and our core layer _will not_ care as it does not concern itself with _how_ the\npersistence layer works.\n\nWith that out of way, let's finally dig into the data access code we'll be writing. From the start, we said we'd be\nworking with Dapper for our database interaction, so let's go ahead and create a new project (a `classlib` in our case).\nAgain, I'll be using the command line, but feel free to spin up the new project in your IDE of choice:\n\n```shell\n~/Dappery/src$ dotnet new classlib -n Dappery.Data\n~/Dappery/src$ dotnet sln ../Dappery.sln add Dappery.Data/Dappery.Data.csproj\n```\n\nWith our persistence library wired up, let's go ahead and update our `.csproj` file within `Dappery.Data` to utilize\nsome of the new features of C# 8. Let's replace the `PropertyGroup` section with the following:\n\n```xml\n<PropertyGroup>\n    <TargetFramework>netstandard2.1</TargetFramework>\n    <Nullable>enable</Nullable>\n    <LangVersion>8.0</LangVersion>\n</PropertyGroup>\n```\n\nTargeting `netstandard2.1` allows us to utilize C# 8 features, and we'll also turn\non [nullable reference types](https://docs.microsoft.com/en-us/dotnet/csharp/nullable-references) to allow the compiler\nto help us catch possible null references. From our dependency graph above, we'll need to create a reference between our\ndata layer and our core layer. For reasons we'll see later, we'll actually need to add just a bit of skeleton code in\nthe core application layer for our data layer to utilize, so let's go ahead and add it now.\n\n```shell\n~/Dappery/src$ dotnet new classlib -n Dappery.Core\n~/Dappery/src$ dotnet sln ../Dappery.sln add Dappery.Core/Dappery.Core.csproj\n```\n\nWith the project added, go ahead and replace the `PropertyGroup` with the above for all the aforementioned reasons. Now,\nback in our `.csproj` file in our data project, let's add the core layer as a dependency. Feel free to create the\nreference using Visual Studio/Rider, as it really only boils down to adding the following line beneath\nthe `PropertyGroup` tag:\n\n```xml\n<ItemGroup>\n    <ProjectReference Include=\"..\\Dappery.Core\\Dappery.Core.csproj\" />\n</ItemGroup>\n```\n\nAs we mentioned above, the data layer will also implicitly rely on the domain layer _through_ its dependency on the core\nlayer. What this means for us, code-wise, is to add the following reference in our `.csproj` file in the core project:\n\n```xml\n<ItemGroup>\n    <ProjectReference Include=\"..\\Dappery.Domain\\Dappery.Domain.csproj\" />\n</ItemGroup>\n```\n\nWith the core project referencing the domain layer, our data project will _also_ have a reference to the domain layer\nwithout explicitly adding the reference in our data layer. Adding the domain project as a direct reference in our data\nproject would actually have created a _symmetric dependency_, which we'll want to try and avoid. With the ceremony out\nof the way, let's talk about what we'll be adding in this layer.\n\n### The Data Layer\n\nAs this is a project revolving around Dapper for our database persistence, it's probably a good idea to bring in some\npatterns to help us define our intent within this layer. Rather that writing raw Dapper queries within this layer, we'll\nwrap our interaction with Dapper within beer and brewery repositories that will, in turn, be wrapped in a unit of work.\nIn plain english, we'll effectively be using\nthe [Repository and Unit of Work Patterns](https://www.c-sharpcorner.com/UploadFile/b1df45/unit-of-work-in-repository-pattern/).\nAlongside bringing in these patterns, a side effect of our clear application layer separation will be the creation of\na [ports and adapters architecture](<https://en.wikipedia.org/wiki/Hexagonal_architecture_(software)>) (also known as\nhexagonal architecture).\n\nFor our use case, our core project will offer a port in the form of data access that our data project will then fill as\nthe adapter. If you're unfamiliar with the repository and unit of work patterns, the specific problems they solve, and\ntheir pros and cons, it's well worth it to take the afternoon to read up on them. For now, we'll assume you're somewhat\nfamiliar with the pattern. With all the technical jargon out of the way, let's go ahead and create a port (effectively\nan `interface`) within our core project, that our data project will provide the adapter for (fancy term for implementing\nthe `interface`). In `Dappery.Core`, go ahead and add a `Data` folder and the following classes:\n\n#### Data/IBeerRepository.cs\n\n```csharp\nnamespace Dappery.Core.Data\n{\n    using System.Collections.Generic;\n    using System.Threading.Tasks;\n    using Domain.Entities;\n\n    public interface IBeerRepository\n    {\n        Task<IEnumerable<Beer>> GetAllBeers();\n\n        Task<Beer> GetBeerById(int id);\n\n        Task<int> CreateBeer(Beer beer);\n\n        Task UpdateBeer(Beer beer);\n\n        Task<int> DeleteBeer(int beer);\n    }\n}\n```\n\n&nbsp;\n\n#### Data/IBeerRepository.cs\n\n```csharp\nnamespace Dappery.Core.Data\n{\n    using System.Collections.Generic;\n    using System.Threading.Tasks;\n    using Domain.Entities;\n\n    public interface IBreweryRepository\n    {\n        Task<IEnumerable<Brewery>> GetAllBreweries();\n\n        Task<Brewery> GetBreweryById(int id);\n\n        Task<int> CreateBrewery(Brewery brewery);\n\n        Task UpdateBrewery(Brewery brewery, bool updateAddress = false);\n\n        Task<int> DeleteBrewery(int breweryId);\n    }\n}\n```\n\n&nbsp;\n\n#### Data/IUnitOfWork.cs\n\n```csharp\nnamespace Dappery.Core.Data\n{\n    using System;\n\n    public interface IUnitOfWork : IDisposable\n    {\n        IBeerRepository BeerRepository { get; }\n\n        IBreweryRepository BreweryRepository { get; }\n\n        void Commit();\n    }\n}\n```\n\n&nbsp;\n\nIn our repositories, we've got all the ingredients for a pretty basic CRUD application. Notice that our `IUnitOfWork`\ninterface inherits from `IDisposable`, as it will be in charge of the database resources that we'll need to clean up\nonce we're finished with our data operations.\n\nFor our database provider, feel free to use whatever your preferred provider happens to be. I lay three options for us:\nSQL Server, Postgres, and SQLite. I'll be spinning up both a SQL Server and Postgres database, as an exercise of\nabstraction to really drive home the point of agnostic data access, using [Postgres](https://hub.docker.com/_/postgres)\nand [SQL Server](https://hub.docker.com/_/microsoft-mssql-server) Docker images. For our unit tests, we'll be using an\nin-memory version of SQLite to run our tests against. If you don't feel like setting up a database for this application,\ndon't worry... I got you. We'll generalize our database layer just enough that you'll be able to use the in-memory\nversion of SQLite for the application as well. Since this isn't _really_ a post about setting up database providers via\nDocker images, so I'll defer to\nthis [article](https://docs.microsoft.com/en-us/sql/linux/quickstart-install-connect-docker?view=sql-server-ver15&pivots=cs1-bash)\non the official Microsoft docs on how to do so for SQL Server, and the aforementioned Docker hub for Postgres. The\nbeauty of the architecture we've laid out so far is that no matter the database provider, our application will work with\njust a simple connection string change.\n\nBefore we get started implementing our repository operations, let's go ahead and setup our database. Once you've got\nyour SQL Server, or Postgres, instance up and running, take a look at\nour [initialization files](https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-2-data-layer/src/Dappery.Data/Scripts)\nto help create, link, and seed some test data for either provider. Go ahead and drop into a console and run the SQL for\nwhich ever provider you decide to roll with.\n\nWith our database ready to roll, let's go ahead and implement the `IBeerRepository.cs` and `IBreweryRepository.cs`\ninterfaces. Within `Dappery.Data`, let's create a `Repositories` folder with the following implementation classes:\n\n#### Repositories/BeerRepository.cs\n\n```csharp\nnamespace Dappery.Data.Repositories\n{\n    using System.Collections.Generic;\n    using System.Data;\n    using System.Linq;\n    using System.Text;\n    using System.Threading.Tasks;\n    using Core.Data;\n    using Dapper;\n    using Domain.Entities;\n\n    public class BeerRepository : IBeerRepository\n    {\n        private readonly IDbTransaction _dbTransaction;\n        private readonly IDbConnection _dbConnection;\n        private readonly string _insertRowRetrievalQuery;\n\n        public BeerRepository(IDbTransaction dbTransaction, string insertRowRetrievalQuery)\n        {\n            _dbTransaction = dbTransaction;\n            _dbConnection = _dbTransaction.Connection;\n            _insertRowRetrievalQuery = insertRowRetrievalQuery;\n        }\n\n        public async Task<IEnumerable<Beer>> GetAllBeers()\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<Beer> GetBeerById(int id)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<Beer> CreateBeer(Beer beer)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<Beer> UpdateBeer(Beer beer)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<int> DeleteBeer(int beerId)\n        {\n            throw new NotImplementedException();\n        }\n    }\n}\n```\n\n&nbsp;\n\n#### Repositories/BreweryRepository.cs\n\n```csharp\nnamespace Dappery.Data.Repositories\n{\n    using System.Collections.Generic;\n    using System.Data;\n    using System.Linq;\n    using System.Text;\n    using System.Threading.Tasks;\n    using Core.Data;\n    using Dapper;\n    using Domain.Entities;\n\n    public class BreweryRepository : IBreweryRepository\n    {\n        private readonly IDbTransaction _dbTransaction;\n        private readonly IDbConnection _dbConnection;\n        private readonly string _rowInsertRetrievalQuery;\n\n        public BreweryRepository(IDbTransaction dbTransaction, string rowInsertRetrievalQuery)\n        {\n            _dbTransaction = dbTransaction;\n            _dbConnection = _dbTransaction.Connection;\n            _rowInsertRetrievalQuery = rowInsertRetrievalQuery;\n        }\n\n        public async Task<Brewery> GetBreweryById(int id)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<IEnumerable<Brewery>> GetAllBreweries()\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<Brewery> CreateBrewery(Brewery brewery)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<Brewery> UpdateBrewery(Brewery brewery, bool updateAddress)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<int> DeleteBrewery(int breweryId)\n        {\n            throw new NotImplementedException();\n        }\n    }\n}\n```\n\n&nbsp;\n\nFor now, some of our imported namespaces are unused, but will be needed later when we start implementing these methods.\nNext, let's add the `UnitOfWork.cs` implementation at the root of our `Dappery.Data` project:\n\n#### UnitOfWork.cs\n\n```csharp\nnamespace Dappery.Data\n{\n    using System;\n    using System.Data;\n    using Core.Data;\n    using Dapper;\n    using Microsoft.Data.SqlClient;\n    using Microsoft.Data.Sqlite;\n    using Npgsql;\n    using Repositories;\n\n    public class UnitOfWork : IUnitOfWork\n    {\n        private readonly IDbConnection _dbConnection;\n        private readonly IDbTransaction _dbTransaction;\n\n        public UnitOfWork(string? connectionString, bool isPostgres = false)\n        {\n            // Based on our database implementation, we'll need a reference to the last row inserted\n            string rowInsertRetrievalQuery;\n\n            // If no connection string is passed, we'll assume we're running with our SQLite database provider\n            if (string.IsNullOrWhiteSpace(connectionString))\n            {\n                _dbConnection = new SqliteConnection(\"Data Source=:memory:\");\n                rowInsertRetrievalQuery = \"; SELECT last_insert_rowid();\";\n            }\n            else\n            {\n                _dbConnection = isPostgres ? (IDbConnection) new NpgsqlConnection(connectionString) : new SqlConnection(connectionString);\n                rowInsertRetrievalQuery = isPostgres ? \"returning Id;\" : \"; SELECT CAST(SCOPE_IDENTITY() as int);\" ;\n            }\n\n            // Open our connection, begin our transaction, and instantiate our repositories\n            _dbConnection.Open();\n            _dbTransaction = _dbConnection.BeginTransaction();\n            BreweryRepository = new BreweryRepository(_dbTransaction, rowInsertRetrievalQuery);\n            BeerRepository = new BeerRepository(_dbTransaction, rowInsertRetrievalQuery);\n\n            // Once our connection is open, if we're running SQLite for unit tests (or that actual application), let's seed some data\n            if (string.IsNullOrWhiteSpace(connectionString))\n            {\n                try\n                {\n                    // We'll seed a couple breweries each with an address and several beers\n                    SeedDatabase(_dbConnection);\n                }\n                catch (Exception e)\n                {\n                    Console.WriteLine($\"Could not seed the database: {e.Message}\");\n                }\n            }\n        }\n\n        public IBreweryRepository BreweryRepository { get; }\n\n        public IBeerRepository BeerRepository { get; }\n\n        public void Commit()\n        {\n            try\n            {\n                _dbTransaction.Commit();\n            }\n            catch (Exception e)\n            {\n                Console.WriteLine($\"Could not commit the transaction, reason: {e.Message}\");\n                _dbTransaction.Rollback();\n            }\n            finally\n            {\n                _dbTransaction.Dispose();\n            }\n        }\n\n        public void Dispose()\n        {\n            Dispose(true);\n            GC.SuppressFinalize(this);\n        }\n\n        protected virtual void Dispose(bool disposing)\n        {\n            if (disposing)\n            {\n                _dbTransaction?.Dispose();\n                _dbConnection?.Dispose();\n            }\n        }\n\n        private void SeedDatabase(IDbConnection dbConnection)\n        {\n            const string createBreweriesSql = @\"\n                CREATE TABLE Breweries (\n                    Id INTEGER PRIMARY KEY,\n                    Name TEXT(32),\n                    CreatedAt DATE,\n                    UpdatedAt DATE\n                );\n            \";\n\n            const string createBeersSql = @\"\n                CREATE TABLE Beers (\n                    Id INTEGER PRIMARY KEY,\n                    Name TEXT(32),\n                    BeerStyle TEXT(16),\n                    CreatedAt DATE,\n                    UpdatedAt DATE,\n                    BreweryId INT NOT NULL,\n                    CONSTRAINT FK_Beers_Breweries_Id FOREIGN KEY (BreweryId)\n                        REFERENCES Breweries (Id) ON DELETE CASCADE\n                );\n            \";\n\n            const string createAddressSql = @\"\n                CREATE TABLE Addresses (\n                    Id INTEGER PRIMARY KEY,\n                    StreetAddress TEXT(32),\n                    City TEXT(32),\n                    State TEXT(32),\n                    ZipCode TEXT(8),\n                    CreatedAt DATE,\n                    UpdatedAt DATE,\n                    BreweryId INTEGER NOT NULL,\n                    CONSTRAINT FK_Address_Breweries_Id FOREIGN KEY (BreweryId)\n                        REFERENCES Breweries (Id) ON DELETE CASCADE\n                );\n            \";\n\n            // Add our tables\n            dbConnection.Execute(createBreweriesSql, _dbTransaction);\n            dbConnection.Execute(createBeersSql, _dbTransaction);\n            dbConnection.Execute(createAddressSql, _dbTransaction);\n\n            // Seed our data\n            dbConnection.Execute(@\"\n                INSERT INTO Breweries (Name, CreatedAt, UpdatedAt)\n                VALUES\n                    (\n                        'Fall River Brewery',\n                        CURRENT_DATE,\n                        CURRENT_DATE\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Breweries (Name, CreatedAt, UpdatedAt)\n                VALUES\n                    (\n                        'Sierra Nevada Brewing Company',\n                        CURRENT_DATE,\n                        CURRENT_DATE\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Addresses (StreetAddress, City, State, ZipCode, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        '1030 E Cypress Ave Ste D',\n                        'Redding',\n                        'CA',\n                        '96002',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        1\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Addresses (StreetAddress, City, State, ZipCode, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        '1075 E 20th St',\n                        'Chico',\n                        'CA',\n                        '95928',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        2\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        'Hexagenia',\n                        'Ipa',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        1\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        'Widowmaker',\n                        'DoubleIpa',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        1\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        'Hooked',\n                        'Lager',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        1\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        'Pale Ale',\n                        'PaleAle',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        2\n                    );\",\n                transaction: _dbTransaction);\n\n            dbConnection.Execute(@\"\n                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)\n                VALUES\n                    (\n                        'Hazy Little Thing',\n                        'NewEnglandIpa',\n                        CURRENT_DATE,\n                        CURRENT_DATE,\n                        2\n                    );\",\n                transaction: _dbTransaction);\n        }\n\n        ~UnitOfWork()\n        {\n            Dispose(false);\n        }\n    }\n}\n```\n\n&nbsp;\n\nOkay... that's a lot of code, so let's break it down:\n\n-   In our constructor, we inject a nullable connection string (since we enabled C# 8, `string`s can now be nullable), and\n    assume that if no connection string is passed, we're probably running unit tests, or just a simple in-memory version\n    of our application. We'll see how this injected connection string will actually be passed into our `UnitOfWork`\n    constructor in our API project in a later post.\n-   Once we figure out who our database provider is, we open the connection, initialize our repositories, and seed some\n    test data (if we're opting to use SQLite)\n-   We pass a the `rowInsertRetrievalQuery` string into our repositories to tell the repository how to get back the row we\n    just added (we'll see why, exactly, we do this later)\n-   We add some public getters to access the repositories through our `UnitOfWork` class\n-   We implement our `Commit` method to try and commit the transaction to the database and rollback if anything unexpected\n    happens\n-   Finally, we add the disposable pattern to safely release our database resources during each transaction and destruct\n    our instance of the `UnitOfWork`\n\nTaking a step back let's take a look at our project structure so far:\n\n![Structure_So_far](/images/net-core-dapper-and-crud-series/part-2/structure_as_of.png)\n\nWith our `UnitOfWork` class implemented, let's finally crank out some of our repository operations. In\nour `BreweryRepository.cs` class, let's implement our `GetAllBreweries` query:\n\n#### BreweryRepository.cs\n\n```csharp\npublic async Task<IEnumerable<Brewery>> GetAllBreweries()\n{\n    // Grab a reference to all beers so we can map them to there corresponding breweries\n    var beers = (await _dbConnection.QueryAsync<Beer>(\n        \"SELECT * FROM Beers\",\n        transaction: _dbTransaction)).ToList();\n\n    return await _dbConnection.QueryAsync<Brewery, Address, Brewery>(\n        // We join with addresses as there's a one-to-one relation with breweries, making the query a little less intensive\n        \"SELECT * FROM Breweries br INNER JOIN Addresses a ON a.BreweryId = br.Id\",\n        (brewery, address) =>\n        {\n            // Map the address to the brewery\n            brewery.Address = address;\n\n            // Map each beer to the beer collection for the brewery during iteration over our result set\n            if (beers.Any(b => b.BreweryId == brewery.Id))\n            {\n                foreach (var beer in beers.Where(b => b.BreweryId == brewery.Id))\n                {\n                    brewery.Beers.Add(beer);\n                }\n            }\n\n            return brewery;\n        },\n        transaction: _dbTransaction);\n}\n```\n\n&nbsp;\n\nLet's breakdown what's going on in this query:\n\n-   First, we grab a reference to all the beers in our database so we can map each beer up to its corresponding brewery\n-   Next, we query the brewery table and do a simple join on the address table\n-   Finally, once we have our result set, we set each brewery's address to the joined address, and add all the beers to\n    the data model (if any exist)\n\nAgain, I'm not an expert with Dapper, so I'm sure there's some optimization to be done here. As this is just us\nexploring Dapper, this will suffice for now. For example, rather than performing two separate queries to get our\nassociated beers that map to their breweries, we could flat query all the beers using some nested sub queries. A few\nissues arise, however, as there are many beers to one brewery, so this might not be the most viable solution - simply\njust food for thought.\n\nSyntactically, Dapper offers some nice ADO.NET-like methods to help us write our queries and commands. We see that\nthe `QueryAsync<Brewery, Address, Brewery>` method sets up the expectation of what this query returns - the first two\ngeneric types tell Dapper that this is a joined query that will contain two of our entities, with the third being the\nentity Dapper should perform the mapping for and ultimately return. We see that one of the parameters in this call is an\nexpression function (the `Func<Brewery, Address>`) that we use to add the reference to the address for the brewery and\nadd all the beers.\n\nLet's jump over to our beer repository and implement the `GetAllBeers` method:\n\n#### BeerRepository.cs\n\n```csharp\npublic async Task<IEnumerable<Beer>> GetAllBeers()\n{\n    // Retrieve the addresses, as this is a nested mapping\n    var addresses = (await _dbConnection.QueryAsync<Address>(\n        \"SELECT * FROM Addresses\",\n        transaction: _dbTransaction)).ToList();\n\n    return await _dbConnection.QueryAsync<Beer, Brewery, Beer>(\n        @\"SELECT b.*, br.* FROM Beers b INNER JOIN Breweries br ON br.Id = b.BreweryId\",\n        (beer, brewery) =>\n        {\n            // Map the brewery that Dapper returns for us to the beer\n            brewery.Address = addresses.FirstOrDefault(a => a.BreweryId == brewery.Id);\n            beer.Brewery = brewery;\n            return beer;\n        },\n        transaction: _dbTransaction\n    );\n}\n```\n\n&nbsp;\n\nAgain, taking a look at what we've done above, this query is pretty straight forward: we retrieve the brewery addresses,\nand then separately query the beers table with the breweries table and map each brewery's address during iteration over\nour result set. Looking good so far, let's bust out those retrieve by ID methods for both entities:\n\n#### BreweryRepository.cs\n\n```csharp\npublic async Task<Brewery> GetBreweryById(int id)\n{\n    var beersFromBrewery = (await _dbConnection.QueryAsync<Beer>(\n        @\"SELECT * FROM Beers WHERE BreweryId = @Id\",\n        new {Id = id},\n        _dbTransaction)).ToList();\n\n    return (await _dbConnection.QueryAsync<Brewery, Address, Brewery>(\n        @\"SELECT br.*, a.* FROM Breweries br INNER JOIN Addresses a ON a.BreweryId = br.Id WHERE br.Id = @Id\",\n        (brewery, address) =>\n        {\n            // Since breweries have a one-to-one relation with address, we can initialize that mapping here\n            brewery.Address = address;\n\n            // Add each beer from the previous query into the list of beers for the brewery\n            if (beersFromBrewery.Any())\n            {\n                foreach (var beer in beersFromBrewery)\n                {\n                    brewery.Beers.Add(beer);\n                }\n            }\n\n            return brewery;\n        },\n        new { Id = id },\n        _dbTransaction)).FirstOrDefault();\n}\n```\n\n&nbsp;\n\n#### BeerRepository.cs\n\n```csharp\npublic async Task<Beer> GetBeerById(int id)\n{\n    // Retrieve the beer from the database\n    var beerFromId = (await _dbConnection.QueryAsync<Beer, Brewery, Beer>(\n        @\"SELECT b.*, br.* FROM Beers b\n        INNER JOIN Breweries br ON br.Id = b.BreweryId\n        WHERE b.Id = @Id\",\n        (beer, brewery) =>\n        {\n            beer.Brewery = brewery;\n            return beer;\n        },\n        new { Id = id },\n        _dbTransaction)).FirstOrDefault();\n\n    // Return back to the caller if no beer is found, let the business logic decide what to do if we can't the specified beer\n    if (beerFromId == null)\n    {\n        return null;\n    }\n\n    // Map the address to the beer's brewery\n    var address = await _dbConnection.QueryFirstOrDefaultAsync<Address>(\n        @\"SELECT * FROM Addresses WHERE BreweryId = @BreweryId\",\n        new { BreweryId = beerFromId.Brewery?.Id },\n        _dbTransaction);\n\n    // Set the address found in the previous query to the beer's brewery address, if we have a brewery\n    if (beerFromId.Brewery != null)\n    {\n        beerFromId.Brewery.Address = address;\n    }\n\n    // Let's add all the beers to our brewery attached to this beer\n    var beersFromBrewery = await _dbConnection.QueryAsync<Beer>(\n        @\"SELECT * FROM Beers WHERE BreweryId = @BreweryId\",\n        new { beerFromId.BreweryId },\n        _dbTransaction);\n\n    // Lastly, let's add all the beers to the entity model\n    foreach (var beer in beersFromBrewery)\n    {\n        beerFromId.Brewery?.Beers.Add(beer);\n    }\n\n    return beerFromId;\n}\n```\n\n&nbsp;\n\nPretty straight forward - the only addition here is the use of Dapper's `QueryFirstOrDefaultAsync<Beer>()` method, which\nwe conveniently use to retrieve the address of the beer's brewery in question, set the brewery address, and finally\nattach all the beers we have in the database to the brewery. Again, I'm no Dapper expert by any means, so I'm sure we\ncould optimize this query quite a bit. For the EF Core fellows in the crowd, the above would be equivalent to\na `.Include().ThenInclude()` query, and while I'm sure we could combine some of the above queries, I break up each query\nfor readability, as well as debug-ability. Next, let's add our create and update commands for each repository:\n\n#### BeerRepository.cs\n\n```csharp\npublic async Task<int> CreateBeer(Beer beer)\n{\n    // From our business rule we defined, we'll assume the brewery ID is always attached to the beer\n    var beerToInsertSql = new StringBuilder(@\"INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)\n                                VALUES (@Name, @BeerStyle, @CreatedAt, @UpdatedAt, @BreweryId)\");\n\n    // Let's insert the beer and grab its ID\n    var beerId = await _dbConnection.ExecuteScalarAsync<int>(\n        beerToInsertSql.Append(_insertRowRetrievalQuery).ToString(),\n        new\n        {\n            beer.Name,\n            beer.BeerStyle,\n            beer.CreatedAt,\n            beer.UpdatedAt,\n            beer.BreweryId\n        },\n        _dbTransaction);\n\n    // Finally, we'll return the newly inserted beer Id\n    return beerId;\n}\n```\n\n&nbsp;\n\n#### BeerRepository.cs\n\n```csharp\npublic async Task UpdateBeer(Beer beer)\n{\n    // Our application layer will be in charge of mapping the new properties to the entity layer,\n    // as well as validating that the beer exists, so the data layer will only be responsible for\n    // inserting the values into the database; separation of concerns!\n    await _dbConnection.ExecuteAsync(\n        @\"UPDATE Beers SET Name = @Name, BeerStyle = @BeerStyle, UpdatedAt = @UpdatedAt, BreweryId = @BreweryId WHERE Id = @Id\",\n        new\n        {\n            beer.Name,\n            beer.BeerStyle,\n            beer.UpdatedAt,\n            beer.BreweryId,\n            beer.Id\n        },\n        _dbTransaction);\n}\n```\n\n&nbsp;\n\n#### BreweryRepository.cs\n\n```csharp\npublic async Task<int> CreateBrewery(Brewery brewery)\n{\n    // Grab a reference to the address\n    var address = brewery.Address;\n    var breweryInsertSql =\n        new StringBuilder(@\"INSERT INTO Breweries (Name, CreatedAt, UpdatedAt) VALUES (@Name, @CreatedAt, @UpdatedAt)\");\n\n    // Let's add the brewery\n    var breweryId = await _dbConnection.ExecuteScalarAsync<int>(\n        breweryInsertSql.Append(_rowInsertRetrievalQuery).ToString(),\n        new { brewery.Name, brewery.CreatedAt, brewery.UpdatedAt },\n        _dbTransaction);\n\n    // One of our business rules is that a brewery must have an associated address\n    await _dbConnection.ExecuteAsync(\n        @\"INSERT INTO Addresses (StreetAddress, City, State, ZipCode, CreatedAt, UpdatedAt, BreweryId)\n                VALUES (@StreetAddress, @City, @State, @ZipCode, @CreatedAt, @UpdatedAt, @BreweryId)\",\n        new\n        {\n            address.StreetAddress,\n            address.City,\n            address.State,\n            address.ZipCode,\n            address.CreatedAt,\n            address.UpdatedAt,\n            BreweryId = breweryId\n        },\n        _dbTransaction);\n\n    return breweryId;\n}\n```\n\n&nbsp;\n\n#### BreweryRepository.cs\n\n```csharp\npublic async Task UpdateBrewery(Brewery brewery, bool updateAddress)\n{\n    // Again, we'll assume the brewery details are being validated and mapped properly in the application layer\n    await _dbConnection.ExecuteAsync(\n        @\"UPDATE Breweries SET Name = @Name, UpdatedAt = @UpdatedAt WHERE Id = @Id\",\n        new\n        {\n            brewery.Name,\n            brewery.UpdatedAt,\n            brewery.Id\n        },\n        _dbTransaction);\n\n    if (brewery.Address != null && updateAddress)\n    {\n        // Again, we'll assume the brewery details are being validated and mapped properly in the application layer\n        // For now, we won't allow users to swap breweries address to another address\n        await _dbConnection.ExecuteAsync(\n            @\"UPDATE Addresses SET StreetAddress = @StreetAddress, City = @City, ZipCode = @ZipCode, State = @State, UpdatedAt = @UpdatedAt WHERE Id = @Id\",\n            new\n            {\n                brewery.Address.StreetAddress,\n                brewery.Address.City,\n                brewery.Address.ZipCode,\n                brewery.Address.State,\n                brewery.Address.UpdatedAt,\n                brewery.Address.Id\n            },\n            _dbTransaction);\n    }\n}\n```\n\n&nbsp;\n\nIn our commands above, notice the absence of checking the entities passed in for validity and the absence of\nexceptions - that's intentional! Our data access layer is responsible for one thing, and one thing only: **database\ninteraction**. That's it; no more, no less. Any checking for request data, throwing exceptions, mapping entities, etc.\nwill _all_ be done in our core business layer, as that is its intended purpose. By keeping our persistence layer as\nsimple as possible and giving it\na [single responsibility](https://en.wikipedia.org/wiki/Single_responsibility_principle) in the form of database access,\nwe've create a boundary in this layer and between all other cross-cutting concerns.\n\nIn our create operations above, we also pass back the last effected row ID (in the case of SQLite and SQL Server) so\nthat we can pass that back to the business layer. There's a few reasons for doing this:\n\n1. By passing back the row ID to the core business layer, we allow our callers to simply query the database again with\n   the inserted entity's row ID for a lightning fast retrieve, should the layer see a need for it (we will be doing\n   this, for example)\n2. With the row ID being returned, the business layer can simply go about its business doing any business logic it needs\n   to validate entities, link relations, etc.\n3. Performing this passing of the last effected row ID in the persistence layer is (arguably) the easiest way to do this\n   type of operation, as we are talking directly to the database in the layer and can easily access the row via SQL\n   rather than having our callers perform a more intensive text based search, for example, in our database\n\nSo why wouldn't we want to do this? Well, there's one big reason where this may become an issue - concurrency. In a real\nworld production database, there are hundreds of thousands (even millions at the enterprise scale) transactions being\nperformed against database everyday. In doing so, there _is_ a non-zero probability that when retrieving the last\neffected row ID, we _could_ get back the ID of another entity that just so happened to be inserted, or updated, at that\nvery moment as well. In practice, our implementation may not be the best approach in a high traffic production\nenvironment, but for our relatively simple application, it'll make do.\n\nI should mention that, again, as we're simply just exploring Dapper in our example application, there's still _a ton_ of\nroom for improvement here. Between our query optimization and testability of this layer, there's a lot of refactoring we\ncould do here to make our code faster and more reliable. For our use case, we'll keep our queries and commands simple\nfor now (as I'm in the same boat as many you - in **no** way a Dapper expert).\n\nLastly, we'll top off our CRUD operations with the implementation of each delete method:\n\n#### BreweryRepository.cs\n\n```csharp\npublic async Task<int> DeleteBrewery(int breweryId)\n{\n    // Because we setup out database providers to cascade delete on parent entity removal, we won't have to\n    // worry about individually removing all the associated beers and address\n    // NOTE: Because we don't directly expose CRUD operations on the address table, we'll validate the cascade\n    // remove directly in the database for now\n    return await _dbConnection.ExecuteAsync(\n            @\"DELETE FROM Breweries WHERE Id = @Id\",\n        new { Id = breweryId },\n        _dbTransaction);\n}\n```\n\n&nbsp;\n\n#### BeerRepository.cs\n\n```csharp\npublic async Task<int> DeleteBeer(int beerId)\n{\n    // Our simplest command, just remove the beer directly from the database\n    // Validation that the beer actually exists in the database will left to the application layer\n    return await _dbConnection.ExecuteAsync(\n        @\"DELETE FROM Beers WHERE Id = @Id\",\n        new { Id = beerId },\n        _dbTransaction);\n}\n```\n\nOur delete operations are simple as can be, just deleting rows from our database (with no validation being performed, as\nthat is an exercise for the business layer). No magic here.\n\nAnd with that... we've _finally_ completed our persistence layer! We've laid the foundation for our core business layer\nto now tap into a database to persist and query data, alongside allowing the option for three difference database\nproviders. Not a bad day's work, if I do say so myself. As a side note, that was _a lot_ of code we just cranked out.\nLet's recap exactly what we did in this post:\n\n1. We bootstrapped our `Dappery.Data` and `Dappery.Core` projects\n2. We implemented CRUD operations using Dapper wrapped within a couple repositories, and all brought together by a unit\n   of work\n3. We kickstarted our databases in the form of SQLite, SQL Server, and Postgres, leaving the choice up to the consumer\n   by simply changing a connection string\n\nOn a rainy day, I'll sit down and guide us through setting up Docker images for database providers and integrating them\nwith our .NET Core applications. For now, I'll leave it as an exercise for the reader on how to do so.\n\nIn our next post, we'll create a simple test project that will help bulletproof our code within this layer, so that any\nchange we decide to make in the future, we'll be able to safely validate that it's still doing its job. After that,\nwe'll implement our business layer that will contain our core CQRS architecture with the help of libraries in MediatR\nand FluentValidation. Check out the source\ncode [here](https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-2-data-layer) to see where we're at so far. Until\nnext time, amigos!\n",
    "html": "<p><em>UPDATE: I've added cancellation token support to each of the database operations below, and encourage readers to\ncheckout the <code>master</code> branch to see how things look now. The methods below we're slight altered to use\na <code>CommandDefinition</code> that utilizes a <code>CancellationToken</code> passed down from the core business logic layer, and used in\nplace of the regular string queries we've written below.</em></p>\n<p>We finally made it... our domain layer is ready to roll, and it's now time to spin up some actual application code. In\nour <a href=\"/images/net-core-dapper-and-crud-buzzword-bingo/\">last post</a>, we setup our initial domain layer for our favorite\nfictional brewery, Dappery (<a href=\"https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-1-domain-layer\">source code</a> for\nreference). In this post, we'll build out the data access layer that will be our primary persistence mechanism into our\ndatabase. We'll make use of SQL server (or Postgres) with Docker and SQLite running our unit tests within this layer.\nFeel free to checkout the <a href=\"https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-2-data-layer\">source code</a> on\nGitHub for this section for those following along.</p>\n<p>Before we jump into the code, let's take a step back and understand <em>why</em> we separate our our data access layer (DAL)\nfrom the rest of our code.</p>\n<p><img src=\"/images/net-core-dapper-and-crud-series/part-2/inward_dependencies.png\" alt=\"Inward_Facing_Dependencies\"></p>\n<p>The good ole fashioned dependency graph, made famous by Robert Martin a.k.a. Dr. Bob, lays out the foundation of domain\ndriven design (DDD). For our relatively simple application, we focus on creating four distinct layers within our\napplication code to ensure that the layers are ultimately, by some chain of dependency, dependent on the domain layer (\neffectively the 'D' in SOLID, <a href=\"https://en.wikipedia.org/wiki/Dependency_inversion_principle\">dependency inversion</a>).\nWith our layers pointing inward toward our domain, we create <em>clear</em> boundaries within our application that deal with\nseparate concerns:</p>\n<ul>\n<li>The web and persistence layers directly depend on our core layer</li>\n<li>Our core layer directly depends on the domain layer</li>\n<li>By association, our web and persistence, inadvertently, have a dependency on our domain layer</li>\n<li>The domain layer has <strong>no</strong> dependencies - all it knows, and cares about, are the entities, view models, DTOs, etc.\nthat live inside this project and how each is related</li>\n</ul>\n<p>Creating these clear boundaries of separation helps to create a modular application, with each layer isolated from one\nanother in perfect harmony. By creating this inversion of dependency within our application, for example, our core layer\n<em>does not</em> need to know about ANY of the internal workings of the data layer - all the core layer cares about is that it\ncan get data from a database using this <a href=\"https://en.wikipedia.org/wiki/Actor_model\">actor</a>. How the persistence layer\ninteracts with the database is entirely abstracted from our core layer. Our data layer can change its data interaction\nmechanism, swap database providers, etc. and our core layer <em>will not</em> care as it does not concern itself with <em>how</em> the\npersistence layer works.</p>\n<p>With that out of way, let's finally dig into the data access code we'll be writing. From the start, we said we'd be\nworking with Dapper for our database interaction, so let's go ahead and create a new project (a <code>classlib</code> in our case).\nAgain, I'll be using the command line, but feel free to spin up the new project in your IDE of choice:</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"shell\" data-theme=\"vitesse-dark\"><code data-language=\"shell\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">~</span><span style=\"color:#DBD7CAEE\">/Dappery/src$ dotnet new classlib -n Dappery.Data</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">~</span><span style=\"color:#DBD7CAEE\">/Dappery/src$ dotnet sln ../Dappery.sln add Dappery.Data/Dappery.Data.csproj</span></span></code></pre></figure>\n<p>With our persistence library wired up, let's go ahead and update our <code>.csproj</code> file within <code>Dappery.Data</code> to utilize\nsome of the new features of C# 8. Let's replace the <code>PropertyGroup</code> section with the following:</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"xml\" data-theme=\"vitesse-dark\"><code data-language=\"xml\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">PropertyGroup</span><span style=\"color:#666666\">></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    &#x3C;</span><span style=\"color:#4D9375\">TargetFramework</span><span style=\"color:#666666\">></span><span style=\"color:#DBD7CAEE\">netstandard2.1</span><span style=\"color:#666666\">&#x3C;/</span><span style=\"color:#4D9375\">TargetFramework</span><span style=\"color:#666666\">></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    &#x3C;</span><span style=\"color:#4D9375\">Nullable</span><span style=\"color:#666666\">></span><span style=\"color:#DBD7CAEE\">enable</span><span style=\"color:#666666\">&#x3C;/</span><span style=\"color:#4D9375\">Nullable</span><span style=\"color:#666666\">></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    &#x3C;</span><span style=\"color:#4D9375\">LangVersion</span><span style=\"color:#666666\">></span><span style=\"color:#DBD7CAEE\">8.0</span><span style=\"color:#666666\">&#x3C;/</span><span style=\"color:#4D9375\">LangVersion</span><span style=\"color:#666666\">></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">&#x3C;/</span><span style=\"color:#4D9375\">PropertyGroup</span><span style=\"color:#666666\">></span></span></code></pre></figure>\n<p>Targeting <code>netstandard2.1</code> allows us to utilize C# 8 features, and we'll also turn\non <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/nullable-references\">nullable reference types</a> to allow the compiler\nto help us catch possible null references. From our dependency graph above, we'll need to create a reference between our\ndata layer and our core layer. For reasons we'll see later, we'll actually need to add just a bit of skeleton code in\nthe core application layer for our data layer to utilize, so let's go ahead and add it now.</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"shell\" data-theme=\"vitesse-dark\"><code data-language=\"shell\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">~</span><span style=\"color:#DBD7CAEE\">/Dappery/src$ dotnet new classlib -n Dappery.Core</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">~</span><span style=\"color:#DBD7CAEE\">/Dappery/src$ dotnet sln ../Dappery.sln add Dappery.Core/Dappery.Core.csproj</span></span></code></pre></figure>\n<p>With the project added, go ahead and replace the <code>PropertyGroup</code> with the above for all the aforementioned reasons. Now,\nback in our <code>.csproj</code> file in our data project, let's add the core layer as a dependency. Feel free to create the\nreference using Visual Studio/Rider, as it really only boils down to adding the following line beneath\nthe <code>PropertyGroup</code> tag:</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"xml\" data-theme=\"vitesse-dark\"><code data-language=\"xml\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">ItemGroup</span><span style=\"color:#666666\">></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    &#x3C;</span><span style=\"color:#4D9375\">ProjectReference</span><span style=\"color:#BD976A\"> Include</span><span style=\"color:#DBD7CAEE\">=</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#C98A7D\">..\\Dappery.Core\\Dappery.Core.csproj</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\"> /></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">&#x3C;/</span><span style=\"color:#4D9375\">ItemGroup</span><span style=\"color:#666666\">></span></span></code></pre></figure>\n<p>As we mentioned above, the data layer will also implicitly rely on the domain layer <em>through</em> its dependency on the core\nlayer. What this means for us, code-wise, is to add the following reference in our <code>.csproj</code> file in the core project:</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"xml\" data-theme=\"vitesse-dark\"><code data-language=\"xml\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">ItemGroup</span><span style=\"color:#666666\">></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    &#x3C;</span><span style=\"color:#4D9375\">ProjectReference</span><span style=\"color:#BD976A\"> Include</span><span style=\"color:#DBD7CAEE\">=</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#C98A7D\">..\\Dappery.Domain\\Dappery.Domain.csproj</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\"> /></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">&#x3C;/</span><span style=\"color:#4D9375\">ItemGroup</span><span style=\"color:#666666\">></span></span></code></pre></figure>\n<p>With the core project referencing the domain layer, our data project will <em>also</em> have a reference to the domain layer\nwithout explicitly adding the reference in our data layer. Adding the domain project as a direct reference in our data\nproject would actually have created a <em>symmetric dependency</em>, which we'll want to try and avoid. With the ceremony out\nof the way, let's talk about what we'll be adding in this layer.</p>\n<h3>The Data Layer</h3>\n<p>As this is a project revolving around Dapper for our database persistence, it's probably a good idea to bring in some\npatterns to help us define our intent within this layer. Rather that writing raw Dapper queries within this layer, we'll\nwrap our interaction with Dapper within beer and brewery repositories that will, in turn, be wrapped in a unit of work.\nIn plain english, we'll effectively be using\nthe <a href=\"https://www.c-sharpcorner.com/UploadFile/b1df45/unit-of-work-in-repository-pattern/\">Repository and Unit of Work Patterns</a>.\nAlongside bringing in these patterns, a side effect of our clear application layer separation will be the creation of\na <a href=\"https://en.wikipedia.org/wiki/Hexagonal_architecture_(software)\">ports and adapters architecture</a> (also known as\nhexagonal architecture).</p>\n<p>For our use case, our core project will offer a port in the form of data access that our data project will then fill as\nthe adapter. If you're unfamiliar with the repository and unit of work patterns, the specific problems they solve, and\ntheir pros and cons, it's well worth it to take the afternoon to read up on them. For now, we'll assume you're somewhat\nfamiliar with the pattern. With all the technical jargon out of the way, let's go ahead and create a port (effectively\nan <code>interface</code>) within our core project, that our data project will provide the adapter for (fancy term for implementing\nthe <code>interface</code>). In <code>Dappery.Core</code>, go ahead and add a <code>Data</code> folder and the following classes:</p>\n<h4>Data/IBeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">namespace</span><span style=\"color:#5DA994\"> Dappery</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Core</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Collections</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Generic</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Threading</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Tasks</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Domain</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Entities</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    public</span><span style=\"color:#CB7676\"> interface</span><span style=\"color:#5DA994\"> IBeerRepository</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">IEnumerable</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">>></span><span style=\"color:#80A665\"> GetAllBeers</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> GetBeerById</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> id</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> CreateBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#80A665\"> UpdateBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> DeleteBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>Data/IBeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">namespace</span><span style=\"color:#5DA994\"> Dappery</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Core</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Collections</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Generic</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Threading</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Tasks</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Domain</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Entities</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    public</span><span style=\"color:#CB7676\"> interface</span><span style=\"color:#5DA994\"> IBreweryRepository</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">IEnumerable</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">>></span><span style=\"color:#80A665\"> GetAllBreweries</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> GetBreweryById</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> id</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> CreateBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#80A665\"> UpdateBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#4D9375\"> bool</span><span style=\"color:#80A665\"> updateAddress</span><span style=\"color:#666666\"> =</span><span style=\"color:#4D9375\"> false</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> DeleteBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> breweryId</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>Data/IUnitOfWork.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">namespace</span><span style=\"color:#5DA994\"> Dappery</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Core</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    public</span><span style=\"color:#CB7676\"> interface</span><span style=\"color:#5DA994\"> IUnitOfWork</span><span style=\"color:#666666\"> :</span><span style=\"color:#5DA994\"> IDisposable</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        IBeerRepository</span><span style=\"color:#80A665\"> BeerRepository</span><span style=\"color:#666666\"> {</span><span style=\"color:#CB7676\"> get</span><span style=\"color:#666666\">;</span><span style=\"color:#666666\"> }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#5DA994\">        IBreweryRepository</span><span style=\"color:#80A665\"> BreweryRepository</span><span style=\"color:#666666\"> {</span><span style=\"color:#CB7676\"> get</span><span style=\"color:#666666\">;</span><span style=\"color:#666666\"> }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">        void</span><span style=\"color:#80A665\"> Commit</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>In our repositories, we've got all the ingredients for a pretty basic CRUD application. Notice that our <code>IUnitOfWork</code>\ninterface inherits from <code>IDisposable</code>, as it will be in charge of the database resources that we'll need to clean up\nonce we're finished with our data operations.</p>\n<p>For our database provider, feel free to use whatever your preferred provider happens to be. I lay three options for us:\nSQL Server, Postgres, and SQLite. I'll be spinning up both a SQL Server and Postgres database, as an exercise of\nabstraction to really drive home the point of agnostic data access, using <a href=\"https://hub.docker.com/_/postgres\">Postgres</a>\nand <a href=\"https://hub.docker.com/_/microsoft-mssql-server\">SQL Server</a> Docker images. For our unit tests, we'll be using an\nin-memory version of SQLite to run our tests against. If you don't feel like setting up a database for this application,\ndon't worry... I got you. We'll generalize our database layer just enough that you'll be able to use the in-memory\nversion of SQLite for the application as well. Since this isn't <em>really</em> a post about setting up database providers via\nDocker images, so I'll defer to\nthis <a href=\"https://docs.microsoft.com/en-us/sql/linux/quickstart-install-connect-docker?view=sql-server-ver15&#x26;pivots=cs1-bash\">article</a>\non the official Microsoft docs on how to do so for SQL Server, and the aforementioned Docker hub for Postgres. The\nbeauty of the architecture we've laid out so far is that no matter the database provider, our application will work with\njust a simple connection string change.</p>\n<p>Before we get started implementing our repository operations, let's go ahead and setup our database. Once you've got\nyour SQL Server, or Postgres, instance up and running, take a look at\nour <a href=\"https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-2-data-layer/src/Dappery.Data/Scripts\">initialization files</a>\nto help create, link, and seed some test data for either provider. Go ahead and drop into a console and run the SQL for\nwhich ever provider you decide to roll with.</p>\n<p>With our database ready to roll, let's go ahead and implement the <code>IBeerRepository.cs</code> and <code>IBreweryRepository.cs</code>\ninterfaces. Within <code>Dappery.Data</code>, let's create a <code>Repositories</code> folder with the following implementation classes:</p>\n<h4>Repositories/BeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">namespace</span><span style=\"color:#5DA994\"> Dappery</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Repositories</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Collections</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Generic</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Linq</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Text</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Threading</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Tasks</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Core</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Dapper</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Domain</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Entities</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    public</span><span style=\"color:#CB7676\"> class</span><span style=\"color:#5DA994\"> BeerRepository</span><span style=\"color:#666666\"> :</span><span style=\"color:#5DA994\"> IBeerRepository</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#5DA994\"> IDbTransaction</span><span style=\"color:#80A665\"> _dbTransaction</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#5DA994\"> IDbConnection</span><span style=\"color:#80A665\"> _dbConnection</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> _insertRowRetrievalQuery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#80A665\"> BeerRepository</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">IDbTransaction</span><span style=\"color:#80A665\"> dbTransaction</span><span style=\"color:#666666\">,</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> insertRowRetrievalQuery</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbTransaction</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> dbTransaction</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbConnection</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Connection</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _insertRowRetrievalQuery</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> insertRowRetrievalQuery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">IEnumerable</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">>></span><span style=\"color:#80A665\"> GetAllBeers</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> GetBeerById</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> id</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> CreateBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> UpdateBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> DeleteBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> beerId</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>Repositories/BreweryRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">namespace</span><span style=\"color:#5DA994\"> Dappery</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Repositories</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Collections</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Generic</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Linq</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Text</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Threading</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Tasks</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Core</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Dapper</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Domain</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Entities</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    public</span><span style=\"color:#CB7676\"> class</span><span style=\"color:#5DA994\"> BreweryRepository</span><span style=\"color:#666666\"> :</span><span style=\"color:#5DA994\"> IBreweryRepository</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#5DA994\"> IDbTransaction</span><span style=\"color:#80A665\"> _dbTransaction</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#5DA994\"> IDbConnection</span><span style=\"color:#80A665\"> _dbConnection</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> _rowInsertRetrievalQuery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#80A665\"> BreweryRepository</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">IDbTransaction</span><span style=\"color:#80A665\"> dbTransaction</span><span style=\"color:#666666\">,</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> rowInsertRetrievalQuery</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbTransaction</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> dbTransaction</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbConnection</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Connection</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _rowInsertRetrievalQuery</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> rowInsertRetrievalQuery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> GetBreweryById</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> id</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">IEnumerable</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">>></span><span style=\"color:#80A665\"> GetAllBreweries</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> CreateBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> UpdateBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#4D9375\"> bool</span><span style=\"color:#80A665\"> updateAddress</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> DeleteBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> breweryId</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            throw</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NotImplementedException</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>For now, some of our imported namespaces are unused, but will be needed later when we start implementing these methods.\nNext, let's add the <code>UnitOfWork.cs</code> implementation at the root of our <code>Dappery.Data</code> project:</p>\n<h4>UnitOfWork.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">namespace</span><span style=\"color:#5DA994\"> Dappery</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> System</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Core</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Dapper</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Microsoft</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">SqlClient</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Microsoft</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Data</span><span style=\"color:#666666\">.</span><span style=\"color:#5DA994\">Sqlite</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Npgsql</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    using</span><span style=\"color:#5DA994\"> Repositories</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    public</span><span style=\"color:#CB7676\"> class</span><span style=\"color:#5DA994\"> UnitOfWork</span><span style=\"color:#666666\"> :</span><span style=\"color:#5DA994\"> IUnitOfWork</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#5DA994\"> IDbConnection</span><span style=\"color:#80A665\"> _dbConnection</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#CB7676\"> readonly</span><span style=\"color:#5DA994\"> IDbTransaction</span><span style=\"color:#80A665\"> _dbTransaction</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#80A665\"> UnitOfWork</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">string</span><span style=\"color:#666666\">?</span><span style=\"color:#80A665\"> connectionString</span><span style=\"color:#666666\">,</span><span style=\"color:#4D9375\"> bool</span><span style=\"color:#80A665\"> isPostgres</span><span style=\"color:#666666\"> =</span><span style=\"color:#4D9375\"> false</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Based on our database implementation, we'll need a reference to the last row inserted</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            string</span><span style=\"color:#80A665\"> rowInsertRetrievalQuery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // If no connection string is passed, we'll assume we're running with our SQLite database provider</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            if</span><span style=\"color:#666666\"> (</span><span style=\"color:#4D9375\">string</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">IsNullOrWhiteSpace</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">connectionString</span><span style=\"color:#666666\">))</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbConnection</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> SqliteConnection</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#C98A7D\">Data Source=:memory:</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                rowInsertRetrievalQuery</span><span style=\"color:#666666\"> =</span><span style=\"color:#C98A7D99\"> \"</span><span style=\"color:#C98A7D\">; SELECT last_insert_rowid();</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            else</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbConnection</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> isPostgres</span><span style=\"color:#CB7676\"> ?</span><span style=\"color:#666666\"> (</span><span style=\"color:#5DA994\">IDbConnection</span><span style=\"color:#666666\">)</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> NpgsqlConnection</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">connectionString</span><span style=\"color:#666666\">)</span><span style=\"color:#CB7676\"> :</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> SqlConnection</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">connectionString</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                rowInsertRetrievalQuery</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> isPostgres</span><span style=\"color:#CB7676\"> ?</span><span style=\"color:#C98A7D99\"> \"</span><span style=\"color:#C98A7D\">returning Id;</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#CB7676\"> :</span><span style=\"color:#C98A7D99\"> \"</span><span style=\"color:#C98A7D\">; SELECT CAST(SCOPE_IDENTITY() as int);</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\"> ;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Open our connection, begin our transaction, and instantiate our repositories</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Open</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbTransaction</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">BeginTransaction</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            BreweryRepository</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> BreweryRepository</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">_dbTransaction</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> rowInsertRetrievalQuery</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            BeerRepository</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> BeerRepository</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">_dbTransaction</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> rowInsertRetrievalQuery</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Once our connection is open, if we're running SQLite for unit tests (or that actual application), let's seed some data</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            if</span><span style=\"color:#666666\"> (</span><span style=\"color:#4D9375\">string</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">IsNullOrWhiteSpace</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">connectionString</span><span style=\"color:#666666\">))</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">                try</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                {</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">                    // We'll seed a couple breweries each with an address and several beers</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                    SeedDatabase</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">_dbConnection</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                }</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">                catch</span><span style=\"color:#666666\"> (</span><span style=\"color:#5DA994\">Exception</span><span style=\"color:#80A665\"> e</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                    Console</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">WriteLine</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">$\"</span><span style=\"color:#C98A7D\">Could not seed the database: </span><span style=\"color:#666666\">{</span><span style=\"color:#C98A7D\">e</span><span style=\"color:#666666\">.</span><span style=\"color:#C98A7D\">Message</span><span style=\"color:#666666\">}</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#5DA994\"> IBreweryRepository</span><span style=\"color:#80A665\"> BreweryRepository</span><span style=\"color:#666666\"> {</span><span style=\"color:#CB7676\"> get</span><span style=\"color:#666666\">;</span><span style=\"color:#666666\"> }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#5DA994\"> IBeerRepository</span><span style=\"color:#80A665\"> BeerRepository</span><span style=\"color:#666666\"> {</span><span style=\"color:#CB7676\"> get</span><span style=\"color:#666666\">;</span><span style=\"color:#666666\"> }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#4D9375\"> void</span><span style=\"color:#80A665\"> Commit</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            try</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbTransaction</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Commit</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            catch</span><span style=\"color:#666666\"> (</span><span style=\"color:#5DA994\">Exception</span><span style=\"color:#80A665\"> e</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                Console</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">WriteLine</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">$\"</span><span style=\"color:#C98A7D\">Could not commit the transaction, reason: </span><span style=\"color:#666666\">{</span><span style=\"color:#C98A7D\">e</span><span style=\"color:#666666\">.</span><span style=\"color:#C98A7D\">Message</span><span style=\"color:#666666\">}</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbTransaction</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Rollback</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            finally</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbTransaction</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Dispose</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        public</span><span style=\"color:#4D9375\"> void</span><span style=\"color:#80A665\"> Dispose</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">            Dispose</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">true</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            GC</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">SuppressFinalize</span><span style=\"color:#666666\">(</span><span style=\"color:#C99076\">this</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        protected</span><span style=\"color:#CB7676\"> virtual</span><span style=\"color:#4D9375\"> void</span><span style=\"color:#80A665\"> Dispose</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">bool</span><span style=\"color:#80A665\"> disposing</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            if</span><span style=\"color:#666666\"> (</span><span style=\"color:#BD976A\">disposing</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbTransaction</span><span style=\"color:#CB7676\">?</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Dispose</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                _dbConnection</span><span style=\"color:#CB7676\">?</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Dispose</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        private</span><span style=\"color:#4D9375\"> void</span><span style=\"color:#80A665\"> SeedDatabase</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">IDbConnection</span><span style=\"color:#80A665\"> dbConnection</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">            const</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> createBreweriesSql</span><span style=\"color:#666666\"> =</span><span style=\"color:#C98A7D99\"> @\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                CREATE TABLE Breweries (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    Id INTEGER PRIMARY KEY,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    Name TEXT(32),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    CreatedAt DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    UpdatedAt DATE</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                );</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">            \"</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">            const</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> createBeersSql</span><span style=\"color:#666666\"> =</span><span style=\"color:#C98A7D99\"> @\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                CREATE TABLE Beers (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    Id INTEGER PRIMARY KEY,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    Name TEXT(32),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    BeerStyle TEXT(16),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    CreatedAt DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    UpdatedAt DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    BreweryId INT NOT NULL,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    CONSTRAINT FK_Beers_Breweries_Id FOREIGN KEY (BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        REFERENCES Breweries (Id) ON DELETE CASCADE</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                );</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">            \"</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#CB7676\">            const</span><span style=\"color:#4D9375\"> string</span><span style=\"color:#80A665\"> createAddressSql</span><span style=\"color:#666666\"> =</span><span style=\"color:#C98A7D99\"> @\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                CREATE TABLE Addresses (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    Id INTEGER PRIMARY KEY,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    StreetAddress TEXT(32),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    City TEXT(32),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    State TEXT(32),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    ZipCode TEXT(8),</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    CreatedAt DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    UpdatedAt DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    BreweryId INTEGER NOT NULL,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    CONSTRAINT FK_Address_Breweries_Id FOREIGN KEY (BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        REFERENCES Breweries (Id) ON DELETE CASCADE</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                );</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">            \"</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Add our tables</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">createBreweriesSql</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">createBeersSql</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">createAddressSql</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Seed our data</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Breweries (Name, CreatedAt, UpdatedAt)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Fall River Brewery',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Breweries (Name, CreatedAt, UpdatedAt)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Sierra Nevada Brewing Company',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Addresses (StreetAddress, City, State, ZipCode, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        '1030 E Cypress Ave Ste D',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Redding',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'CA',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        '96002',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        1</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Addresses (StreetAddress, City, State, ZipCode, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        '1075 E 20th St',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Chico',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'CA',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        '95928',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        2</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Hexagenia',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Ipa',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        1</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Widowmaker',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'DoubleIpa',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        1</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Hooked',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Lager',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        1</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Pale Ale',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'PaleAle',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        2</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Execute</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    (</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'Hazy Little Thing',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        'NewEnglandIpa',</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        CURRENT_DATE,</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                        2</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                    );</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">                transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#666666\">        ~</span><span style=\"color:#80A665\">UnitOfWork</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">            Dispose</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">false</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>Okay... that's a lot of code, so let's break it down:</p>\n<ul>\n<li>In our constructor, we inject a nullable connection string (since we enabled C# 8, <code>string</code>s can now be nullable), and\nassume that if no connection string is passed, we're probably running unit tests, or just a simple in-memory version\nof our application. We'll see how this injected connection string will actually be passed into our <code>UnitOfWork</code>\nconstructor in our API project in a later post.</li>\n<li>Once we figure out who our database provider is, we open the connection, initialize our repositories, and seed some\ntest data (if we're opting to use SQLite)</li>\n<li>We pass a the <code>rowInsertRetrievalQuery</code> string into our repositories to tell the repository how to get back the row we\njust added (we'll see why, exactly, we do this later)</li>\n<li>We add some public getters to access the repositories through our <code>UnitOfWork</code> class</li>\n<li>We implement our <code>Commit</code> method to try and commit the transaction to the database and rollback if anything unexpected\nhappens</li>\n<li>Finally, we add the disposable pattern to safely release our database resources during each transaction and destruct\nour instance of the <code>UnitOfWork</code></li>\n</ul>\n<p>Taking a step back let's take a look at our project structure so far:</p>\n<p><img src=\"/images/net-core-dapper-and-crud-series/part-2/structure_as_of.png\" alt=\"Structure_So_far\"></p>\n<p>With our <code>UnitOfWork</code> class implemented, let's finally crank out some of our repository operations. In\nour <code>BreweryRepository.cs</code> class, let's implement our <code>GetAllBreweries</code> query:</p>\n<h4>BreweryRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">IEnumerable</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">>></span><span style=\"color:#80A665\"> GetAllBreweries</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Grab a reference to all beers so we can map them to there corresponding breweries</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> beers</span><span style=\"color:#666666\"> =</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        \"</span><span style=\"color:#C98A7D\">SELECT * FROM Beers</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">        transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">)).</span><span style=\"color:#80A665\">ToList</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Address</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Brewery</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">        // We join with addresses as there's a one-to-one relation with breweries, making the query a little less intensive</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        \"</span><span style=\"color:#C98A7D\">SELECT * FROM Breweries br INNER JOIN Addresses a ON a.BreweryId = br.Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        (</span><span style=\"color:#80A665\">brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#80A665\"> address</span><span style=\"color:#666666\">)</span><span style=\"color:#CB7676\"> =></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Map the address to the brewery</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> address</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Map each beer to the beer collection for the brewery during iteration over our result set</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            if</span><span style=\"color:#666666\"> (</span><span style=\"color:#BD976A\">beers</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Any</span><span style=\"color:#666666\">(</span><span style=\"color:#80A665\">b</span><span style=\"color:#CB7676\"> =></span><span style=\"color:#BD976A\"> b</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BreweryId</span><span style=\"color:#CB7676\"> ==</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span><span style=\"color:#666666\">))</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">                foreach</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">var</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#4D9375\"> in</span><span style=\"color:#BD976A\"> beers</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Where</span><span style=\"color:#666666\">(</span><span style=\"color:#80A665\">b</span><span style=\"color:#CB7676\"> =></span><span style=\"color:#BD976A\"> b</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BreweryId</span><span style=\"color:#CB7676\"> ==</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span><span style=\"color:#666666\">))</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                    brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Beers</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Add</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">beer</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            return</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">        transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>Let's breakdown what's going on in this query:</p>\n<ul>\n<li>First, we grab a reference to all the beers in our database so we can map each beer up to its corresponding brewery</li>\n<li>Next, we query the brewery table and do a simple join on the address table</li>\n<li>Finally, once we have our result set, we set each brewery's address to the joined address, and add all the beers to\nthe data model (if any exist)</li>\n</ul>\n<p>Again, I'm not an expert with Dapper, so I'm sure there's some optimization to be done here. As this is just us\nexploring Dapper, this will suffice for now. For example, rather than performing two separate queries to get our\nassociated beers that map to their breweries, we could flat query all the beers using some nested sub queries. A few\nissues arise, however, as there are many beers to one brewery, so this might not be the most viable solution - simply\njust food for thought.</p>\n<p>Syntactically, Dapper offers some nice ADO.NET-like methods to help us write our queries and commands. We see that\nthe <code>QueryAsync&#x3C;Brewery, Address, Brewery></code> method sets up the expectation of what this query returns - the first two\ngeneric types tell Dapper that this is a joined query that will contain two of our entities, with the third being the\nentity Dapper should perform the mapping for and ultimately return. We see that one of the parameters in this call is an\nexpression function (the <code>Func&#x3C;Brewery, Address></code>) that we use to add the reference to the address for the brewery and\nadd all the beers.</p>\n<p>Let's jump over to our beer repository and implement the <code>GetAllBeers</code> method:</p>\n<h4>BeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">IEnumerable</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">>></span><span style=\"color:#80A665\"> GetAllBeers</span><span style=\"color:#666666\">()</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Retrieve the addresses, as this is a nested mapping</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> addresses</span><span style=\"color:#666666\"> =</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Address</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        \"</span><span style=\"color:#C98A7D\">SELECT * FROM Addresses</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">        transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span><span style=\"color:#666666\">)).</span><span style=\"color:#80A665\">ToList</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Beer</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">SELECT b.*, br.* FROM Beers b INNER JOIN Breweries br ON br.Id = b.BreweryId</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        (</span><span style=\"color:#80A665\">beer</span><span style=\"color:#666666\">,</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">)</span><span style=\"color:#CB7676\"> =></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Map the brewery that Dapper returns for us to the beer</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> addresses</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">FirstOrDefault</span><span style=\"color:#666666\">(</span><span style=\"color:#80A665\">a</span><span style=\"color:#CB7676\"> =></span><span style=\"color:#BD976A\"> a</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BreweryId</span><span style=\"color:#CB7676\"> ==</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Brewery</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            return</span><span style=\"color:#BD976A\"> beer</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#80A665\">        transaction</span><span style=\"color:#666666\">:</span><span style=\"color:#BD976A\"> _dbTransaction</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    );</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>Again, taking a look at what we've done above, this query is pretty straight forward: we retrieve the brewery addresses,\nand then separately query the beers table with the breweries table and map each brewery's address during iteration over\nour result set. Looking good so far, let's bust out those retrieve by ID methods for both entities:</p>\n<h4>BreweryRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> GetBreweryById</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> id</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> beersFromBrewery</span><span style=\"color:#666666\"> =</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">SELECT * FROM Beers WHERE BreweryId = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\">Id</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> id</span><span style=\"color:#666666\">},</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">)).</span><span style=\"color:#80A665\">ToList</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Address</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Brewery</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">SELECT br.*, a.* FROM Breweries br INNER JOIN Addresses a ON a.BreweryId = br.Id WHERE br.Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        (</span><span style=\"color:#80A665\">brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#80A665\"> address</span><span style=\"color:#666666\">)</span><span style=\"color:#CB7676\"> =></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Since breweries have a one-to-one relation with address, we can initialize that mapping here</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> address</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">            // Add each beer from the previous query into the list of beers for the brewery</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            if</span><span style=\"color:#666666\"> (</span><span style=\"color:#BD976A\">beersFromBrewery</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Any</span><span style=\"color:#666666\">())</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">                foreach</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">var</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#4D9375\"> in</span><span style=\"color:#BD976A\"> beersFromBrewery</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                    brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Beers</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Add</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">beer</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">                }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            return</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> Id</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> id</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">)).</span><span style=\"color:#80A665\">FirstOrDefault</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>BeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> GetBeerById</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> id</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Retrieve the beer from the database</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> beerFromId</span><span style=\"color:#666666\"> =</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#5DA994\"> Beer</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">SELECT b.*, br.* FROM Beers b</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">        INNER JOIN Breweries br ON br.Id = b.BreweryId</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">        WHERE b.Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        (</span><span style=\"color:#80A665\">beer</span><span style=\"color:#666666\">,</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">)</span><span style=\"color:#CB7676\"> =></span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Brewery</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">            return</span><span style=\"color:#BD976A\"> beer</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> Id</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> id</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">)).</span><span style=\"color:#80A665\">FirstOrDefault</span><span style=\"color:#666666\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Return back to the caller if no beer is found, let the business logic decide what to do if we can't the specified beer</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    if</span><span style=\"color:#666666\"> (</span><span style=\"color:#BD976A\">beerFromId</span><span style=\"color:#CB7676\"> ==</span><span style=\"color:#CB7676\"> null</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">        return</span><span style=\"color:#CB7676\"> null</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Map the address to the beer's brewery</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> address</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryFirstOrDefaultAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Address</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">SELECT * FROM Addresses WHERE BreweryId = @BreweryId</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> BreweryId</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> beerFromId</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Brewery</span><span style=\"color:#CB7676\">?</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Set the address found in the previous query to the beer's brewery address, if we have a brewery</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    if</span><span style=\"color:#666666\"> (</span><span style=\"color:#BD976A\">beerFromId</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Brewery</span><span style=\"color:#CB7676\"> !=</span><span style=\"color:#CB7676\"> null</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        beerFromId</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> address</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Let's add all the beers to our brewery attached to this beer</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> beersFromBrewery</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">QueryAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">SELECT * FROM Beers WHERE BreweryId = @BreweryId</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> beerFromId</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BreweryId</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Lastly, let's add all the beers to the entity model</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    foreach</span><span style=\"color:#666666\"> (</span><span style=\"color:#CB7676\">var</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#4D9375\"> in</span><span style=\"color:#BD976A\"> beersFromBrewery</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        beerFromId</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Brewery</span><span style=\"color:#CB7676\">?</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Beers</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Add</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">beer</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#BD976A\"> beerFromId</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>Pretty straight forward - the only addition here is the use of Dapper's <code>QueryFirstOrDefaultAsync&#x3C;Beer>()</code> method, which\nwe conveniently use to retrieve the address of the beer's brewery in question, set the brewery address, and finally\nattach all the beers we have in the database to the brewery. Again, I'm no Dapper expert by any means, so I'm sure we\ncould optimize this query quite a bit. For the EF Core fellows in the crowd, the above would be equivalent to\na <code>.Include().ThenInclude()</code> query, and while I'm sure we could combine some of the above queries, I break up each query\nfor readability, as well as debug-ability. Next, let's add our create and update commands for each repository:</p>\n<h4>BeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> CreateBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // From our business rule we defined, we'll assume the brewery ID is always attached to the beer</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> beerToInsertSql</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> new</span><span style=\"color:#5DA994\"> StringBuilder</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span><span style=\"color:#C98A7D\">INSERT INTO Beers (Name, BeerStyle, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                                VALUES (@Name, @BeerStyle, @CreatedAt, @UpdatedAt, @BreweryId)</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Let's insert the beer and grab its ID</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> beerId</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteScalarAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        beerToInsertSql</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Append</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">_insertRowRetrievalQuery</span><span style=\"color:#666666\">).</span><span style=\"color:#80A665\">ToString</span><span style=\"color:#666666\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Name</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BeerStyle</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">CreatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">UpdatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BreweryId</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Finally, we'll return the newly inserted beer Id</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#BD976A\"> beerId</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>BeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#80A665\"> UpdateBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Beer</span><span style=\"color:#80A665\"> beer</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Our application layer will be in charge of mapping the new properties to the entity layer,</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // as well as validating that the beer exists, so the data layer will only be responsible for</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // inserting the values into the database; separation of concerns!</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteAsync</span><span style=\"color:#666666\">(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">UPDATE Beers SET Name = @Name, BeerStyle = @BeerStyle, UpdatedAt = @UpdatedAt, BreweryId = @BreweryId WHERE Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Name</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BeerStyle</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">UpdatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">BreweryId</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            beer</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>BreweryRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> CreateBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Grab a reference to the address</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> address</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> breweryInsertSql</span><span style=\"color:#666666\"> =</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#5DA994\"> StringBuilder</span><span style=\"color:#666666\">(</span><span style=\"color:#C98A7D99\">@\"</span><span style=\"color:#C98A7D\">INSERT INTO Breweries (Name, CreatedAt, UpdatedAt) VALUES (@Name, @CreatedAt, @UpdatedAt)</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Let's add the brewery</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    var</span><span style=\"color:#80A665\"> breweryId</span><span style=\"color:#666666\"> =</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteScalarAsync</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">>(</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        breweryInsertSql</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">Append</span><span style=\"color:#666666\">(</span><span style=\"color:#BD976A\">_rowInsertRetrievalQuery</span><span style=\"color:#666666\">).</span><span style=\"color:#80A665\">ToString</span><span style=\"color:#666666\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Name</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">CreatedAt</span><span style=\"color:#666666\">,</span><span style=\"color:#BD976A\"> brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">UpdatedAt</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // One of our business rules is that a brewery must have an associated address</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteAsync</span><span style=\"color:#666666\">(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">INSERT INTO Addresses (StreetAddress, City, State, ZipCode, CreatedAt, UpdatedAt, BreweryId)</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D\">                VALUES (@StreetAddress, @City, @State, @ZipCode, @CreatedAt, @UpdatedAt, @BreweryId)</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">StreetAddress</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">City</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">State</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">ZipCode</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">CreatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">UpdatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            BreweryId</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> breweryId</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#BD976A\"> breweryId</span><span style=\"color:#666666\">;</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>BreweryRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#80A665\"> UpdateBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#5DA994\">Brewery</span><span style=\"color:#80A665\"> brewery</span><span style=\"color:#666666\">,</span><span style=\"color:#4D9375\"> bool</span><span style=\"color:#80A665\"> updateAddress</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Again, we'll assume the brewery details are being validated and mapped properly in the application layer</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">    await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteAsync</span><span style=\"color:#666666\">(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">UPDATE Breweries SET Name = @Name, UpdatedAt = @UpdatedAt WHERE Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Name</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">UpdatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">        },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    if</span><span style=\"color:#666666\"> (</span><span style=\"color:#BD976A\">brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#CB7676\"> !=</span><span style=\"color:#CB7676\"> null</span><span style=\"color:#CB7676\"> &#x26;&#x26;</span><span style=\"color:#BD976A\"> updateAddress</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">        // Again, we'll assume the brewery details are being validated and mapped properly in the application layer</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">        // For now, we won't allow users to swap breweries address to another address</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteAsync</span><span style=\"color:#666666\">(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">            @\"</span><span style=\"color:#C98A7D\">UPDATE Addresses SET StreetAddress = @StreetAddress, City = @City, ZipCode = @ZipCode, State = @State, UpdatedAt = @UpdatedAt WHERE Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">            new</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">StreetAddress</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">City</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">ZipCode</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">State</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">UpdatedAt</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">                brewery</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Address</span><span style=\"color:#666666\">.</span><span style=\"color:#BD976A\">Id</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">            },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">            _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<p>In our commands above, notice the absence of checking the entities passed in for validity and the absence of\nexceptions - that's intentional! Our data access layer is responsible for one thing, and one thing only: <strong>database\ninteraction</strong>. That's it; no more, no less. Any checking for request data, throwing exceptions, mapping entities, etc.\nwill <em>all</em> be done in our core business layer, as that is its intended purpose. By keeping our persistence layer as\nsimple as possible and giving it\na <a href=\"https://en.wikipedia.org/wiki/Single_responsibility_principle\">single responsibility</a> in the form of database access,\nwe've create a boundary in this layer and between all other cross-cutting concerns.</p>\n<p>In our create operations above, we also pass back the last effected row ID (in the case of SQLite and SQL Server) so\nthat we can pass that back to the business layer. There's a few reasons for doing this:</p>\n<ol>\n<li>By passing back the row ID to the core business layer, we allow our callers to simply query the database again with\nthe inserted entity's row ID for a lightning fast retrieve, should the layer see a need for it (we will be doing\nthis, for example)</li>\n<li>With the row ID being returned, the business layer can simply go about its business doing any business logic it needs\nto validate entities, link relations, etc.</li>\n<li>Performing this passing of the last effected row ID in the persistence layer is (arguably) the easiest way to do this\ntype of operation, as we are talking directly to the database in the layer and can easily access the row via SQL\nrather than having our callers perform a more intensive text based search, for example, in our database</li>\n</ol>\n<p>So why wouldn't we want to do this? Well, there's one big reason where this may become an issue - concurrency. In a real\nworld production database, there are hundreds of thousands (even millions at the enterprise scale) transactions being\nperformed against database everyday. In doing so, there <em>is</em> a non-zero probability that when retrieving the last\neffected row ID, we <em>could</em> get back the ID of another entity that just so happened to be inserted, or updated, at that\nvery moment as well. In practice, our implementation may not be the best approach in a high traffic production\nenvironment, but for our relatively simple application, it'll make do.</p>\n<p>I should mention that, again, as we're simply just exploring Dapper in our example application, there's still <em>a ton</em> of\nroom for improvement here. Between our query optimization and testability of this layer, there's a lot of refactoring we\ncould do here to make our code faster and more reliable. For our use case, we'll keep our queries and commands simple\nfor now (as I'm in the same boat as many you - in <strong>no</strong> way a Dapper expert).</p>\n<p>Lastly, we'll top off our CRUD operations with the implementation of each delete method:</p>\n<h4>BreweryRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> DeleteBrewery</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> breweryId</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Because we setup out database providers to cascade delete on parent entity removal, we won't have to</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // worry about individually removing all the associated beers and address</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // NOTE: Because we don't directly expose CRUD operations on the address table, we'll validate the cascade</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // remove directly in the database for now</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteAsync</span><span style=\"color:#666666\">(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">            @\"</span><span style=\"color:#C98A7D\">DELETE FROM Breweries WHERE Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> Id</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> breweryId</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p></p>\n<h4>BeerRepository.cs</h4>\n<figure data-rehype-pretty-code-figure=\"\"><pre style=\"background-color:#121212;color:#dbd7caee\" tabindex=\"0\" data-language=\"csharp\" data-theme=\"vitesse-dark\"><code data-language=\"csharp\" data-theme=\"vitesse-dark\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#CB7676\">public</span><span style=\"color:#CB7676\"> async</span><span style=\"color:#5DA994\"> Task</span><span style=\"color:#666666\">&#x3C;</span><span style=\"color:#4D9375\">int</span><span style=\"color:#666666\">></span><span style=\"color:#80A665\"> DeleteBeer</span><span style=\"color:#666666\">(</span><span style=\"color:#4D9375\">int</span><span style=\"color:#80A665\"> beerId</span><span style=\"color:#666666\">)</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">{</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Our simplest command, just remove the beer directly from the database</span></span>\n<span data-line=\"\"><span style=\"color:#758575DD\">    // Validation that the beer actually exists in the database will left to the application layer</span></span>\n<span data-line=\"\"><span style=\"color:#4D9375\">    return</span><span style=\"color:#CB7676\"> await</span><span style=\"color:#BD976A\"> _dbConnection</span><span style=\"color:#666666\">.</span><span style=\"color:#80A665\">ExecuteAsync</span><span style=\"color:#666666\">(</span></span>\n<span data-line=\"\"><span style=\"color:#C98A7D99\">        @\"</span><span style=\"color:#C98A7D\">DELETE FROM Beers WHERE Id = @Id</span><span style=\"color:#C98A7D99\">\"</span><span style=\"color:#666666\">,</span></span>\n<span data-line=\"\"><span style=\"color:#CB7676\">        new</span><span style=\"color:#666666\"> {</span><span style=\"color:#BD976A\"> Id</span><span style=\"color:#666666\"> =</span><span style=\"color:#BD976A\"> beerId</span><span style=\"color:#666666\"> },</span></span>\n<span data-line=\"\"><span style=\"color:#BD976A\">        _dbTransaction</span><span style=\"color:#666666\">);</span></span>\n<span data-line=\"\"><span style=\"color:#666666\">}</span></span></code></pre></figure>\n<p>Our delete operations are simple as can be, just deleting rows from our database (with no validation being performed, as\nthat is an exercise for the business layer). No magic here.</p>\n<p>And with that... we've <em>finally</em> completed our persistence layer! We've laid the foundation for our core business layer\nto now tap into a database to persist and query data, alongside allowing the option for three difference database\nproviders. Not a bad day's work, if I do say so myself. As a side note, that was <em>a lot</em> of code we just cranked out.\nLet's recap exactly what we did in this post:</p>\n<ol>\n<li>We bootstrapped our <code>Dappery.Data</code> and <code>Dappery.Core</code> projects</li>\n<li>We implemented CRUD operations using Dapper wrapped within a couple repositories, and all brought together by a unit\nof work</li>\n<li>We kickstarted our databases in the form of SQLite, SQL Server, and Postgres, leaving the choice up to the consumer\nby simply changing a connection string</li>\n</ol>\n<p>On a rainy day, I'll sit down and guide us through setting up Docker images for database providers and integrating them\nwith our .NET Core applications. For now, I'll leave it as an exercise for the reader on how to do so.</p>\n<p>In our next post, we'll create a simple test project that will help bulletproof our code within this layer, so that any\nchange we decide to make in the future, we'll be able to safely validate that it's still doing its job. After that,\nwe'll implement our business layer that will contain our core CQRS architecture with the help of libraries in MediatR\nand FluentValidation. Check out the source\ncode <a href=\"https://github.com/JoeyMckenzie/Dappery/tree/dappery-part-2-data-layer\">here</a> to see where we're at so far. Until\nnext time, amigos!</p>"
  },
  "_id": "2019/net-core-dapper-and-crud-buzzword-bingo-part-2.md",
  "_raw": {
    "sourceFilePath": "2019/net-core-dapper-and-crud-buzzword-bingo-part-2.md",
    "sourceFileName": "net-core-dapper-and-crud-buzzword-bingo-part-2.md",
    "sourceFileDir": "2019",
    "contentType": "markdown",
    "flattenedPath": "2019/net-core-dapper-and-crud-buzzword-bingo-part-2"
  },
  "type": "Post",
  "url": "/blog/2019/net-core-dapper-and-crud-buzzword-bingo-part-2"
}